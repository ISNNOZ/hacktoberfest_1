# Intersmash examples - Wildfly with Keycloak SAML Adapter Galleon Pack

This example shows how to use Intersmash to provision and test a WildFly application on OpenShift via a s2i binary 
build.

## Overview 
The application is a simple "Hello World!" Java EE application, which is executed by a WildFly instance that is 
provisioned via the WildFly Maven Plugin. Such plugin allows for tailoring a WildFly server with just the 
required modules and configuration enabled.

In this example, the application project POM also demonstrates how to configure the plugin for adding the WildFly 
Keycloak SAML Adapter Galleon Pack and the related `keycloak-saml` layer to the server configuration.

There is no interoperability involved in this example, as there isn't a Keycloak server that the WildFly application 
interacts with, and the test ony verifies that the server configuration contains the elements related to the 
Keycloak SAML Adapter resources.

## Test code
The test code consists of an Intersmash _application descriptor_ class, i.e. 
[KeycloakCapableImageBasedWildflyApplication](../wildfly-keycloak-saml-adapter/src/test/java/org/jboss/intersmash/examples/wildfly/keycloak/saml/KeycloakCapableImageBasedWildflyApplication.java) 
and an Intersmash test class, i.e.
[KeycloakCapableImageBasedWildflyApplicationTest](../wildfly-keycloak-saml-adapter/src/test/java/org/jboss/intersmash/examples/wildfly/keycloak/saml/KeycloakCapableImageBasedWildflyApplicationTest.java).

### The _application descriptor_
[KeycloakCapableImageBasedWildflyApplication](../wildfly-keycloak-saml-adapter/src/test/java/org/jboss/intersmash/examples/wildfly/keycloak/saml/KeycloakCapableImageBasedWildflyApplication.java) provides the information that the provisioner will use to deploy the 
service on OpenShift. For instance, it can define environment variables, or secrets, and the build input. 
This is the input for the s2i build that the provisioner will orchestrate on 
OpenShift, in order to generate the final immutable image containing the WildFly application server and the 
application deployment itself.
In our case the build input is represented by a local WildFly deployment, as generated by the WildFly Maven plugin 
execution. 

#### Resolving the build input
The [templating-maven-plugin](https://www.mojohaus.org/templating-maven-plugin/) is used to have - for example - Maven 
project properties injected with concrete values in Java classes at runtime. 

When built, this example uses such plugin in order to generate the
`KeycloackCapableWildflyDeploymentConfiguration` Java class from the 
[KeycloackCapableWildflyDeploymentConfiguration.java](../wildfly-keycloak-saml-adapter/src/test/resources/java-templates/org/jboss/intersmash/examples/wildfly/keycloak/saml/config/KeycloackCapableWildflyDeploymentConfiguration.java) template. 
This class contains the information needed to identify the built artifact properties or location, and is used by 
[KeycloakCapableImageBasedWildflyApplication](../wildfly-keycloak-saml-adapter/src/test/java/org/jboss/intersmash/examples/wildfly/keycloak/saml/KeycloakCapableImageBasedWildflyApplication.java) 
to initialize the build input with the `target/server` directory produced by the WildFly Maven Plugin.

#### The _provisioner_
The _provisioner_ is 
[selected by Intersmash](../../../intersmash/provisioners/README.md#mapping-of-implemented-provisioners-), based on the 
`Application` type that a given _application descriptor_ implements.

[KeycloakCapableImageBasedWildflyApplication](../wildfly-keycloak-saml-adapter/src/test/java/org/jboss/intersmash/examples/wildfly/keycloak/saml/KeycloakCapableImageBasedWildflyApplication.java) 
extends 
[WildflyImageOpenShiftApplication](../../../intersmash/provisioners/src/main/java/org/jboss/intersmash/application/openshift/WildflyImageOpenShiftApplication.java) 
which is provisioned by 
[WildflyImageOpenShiftProvisioner](/../../../intersmash/provisioners/src/main/java/org/jboss/intersmash/provision/openshift/WildflyImageOpenShiftProvisioner.java).

Such provisioner infers the build input runtime type in order to create the resources for either a source or binary 
based s2i build to happen on OpenShift and to generate the final WildFly application image that will be fed to a 
`DeploymentConfig` resource, which is eventually used for orchestrating the pods that run the actual application 
service workload.

### The test class

[KeycloakCapableImageBasedWildflyApplicationTest](../wildfly-keycloak-saml-adapter/src/test/java/org/jboss/intersmash/examples/wildfly/keycloak/saml/KeycloakCapableImageBasedWildflyApplicationTest.java) 
is a valid Intersmash test class - as per the `@Intersmash` annotation, and its lifecycle is fully managed by 
Intersmash, based on the information provided by the `@Service` annotations.
The scenario consists of just one service, i.e. the one represented by the
[KeycloakCapableImageBasedWildflyApplication](../wildfly-keycloak-saml-adapter/src/test/java/org/jboss/intersmash/examples/wildfly/keycloak/saml/KeycloakCapableImageBasedWildflyApplication.java)
_application descriptor_.
It uses the `@ServiceUrl` annotation in order to let Intersmash inject the URL that exposes the application service 
outside OpenShift, and which is used by one test method, which is a simple call to check that the server 
configuration actually contains the resources defined by the WildFly Keycloak SAML Adapter Galleon pack.

## Running the test

After building the project, just issue:
```shell
mvn clean install -Pdemo -pl examples/wildfly-keycloak-saml-adapter
```

Or simply start the [test](../wildfly-keycloak-saml-adapter/src/test/java/org/jboss/intersmash/examples/wildfly/keycloak/saml/KeycloakCapableImageBasedWildflyApplicationTest.java) within your favourite IDE.
